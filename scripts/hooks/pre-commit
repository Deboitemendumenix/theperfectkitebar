#!/bin/bash

# Remove Windows metadata files that sneak in
find . -type f -name "*:Zone.Identifier" -exec rm -f {} \;

# Custom .shapr splitter logic
CHUNKSIZE=95M
LIMIT=$((100 * 1024 * 1024))

for file in $(git diff --cached --name-only --diff-filter=ACM | grep '\.shapr$'); do
  if [ -f "$file" ]; then
    size=$(stat -c%s "$file")
    if [ "$size" -ge "$LIMIT" ]; then
      echo "Large .shapr file: $file ($((size/1024/1024))MB)"

      # Add to .gitignore if not ignored
      if ! grep -qxF "$file" .gitignore; then
        echo "$file" >> .gitignore
        git add .gitignore
        echo "Added $file to .gitignore"
      fi

      # Split file and stage parts
      split -b "$CHUNKSIZE" -d -a 3 "$file" "$file.part"
      git add "$file".part*
    fi
  fi
done
